rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // --- Hardcoded Admin User ID ---
    function isAdmin() {
      return request.auth.uid == 'sRiwSuQlxgbGRUcO7CevaJxQBEq2';
    }
    
    // --- Helper function to check if a user is authenticated ---
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // --- Helper function to check if the user is the owner of the document ---
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Default Deny: Secure by default.
    match /{document=**} {
      allow read, write: if false;
    }

    // USERS
    // Users can be created by anyone (for signup).
    // Users can only read/update their own data.
    // The Admin can read/write any user's data.
    match /users/{userId} {
      allow create: if true;
      allow read, update: if isOwner(userId) || isAdmin();
      
      // Progress data is private to the user, but the admin can also view it.
      match /progress/{docId} {
         allow read, write: if isOwner(userId) || isAdmin();
      }
    }
    
    // NOTES
    // Authenticated users can read all notes.
    // Only the Admin can create, update, or delete notes.
    match /notes/{noteId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // NEWSLETTER SUBSCRIPTIONS
    // Anyone can subscribe to the newsletter (create).
    // Only the Admin can read or delete subscriptions.
    match /newsletter_subscriptions/{subId} {
      allow create: if true;
      allow read, delete: if isAdmin();
    }
    
    // MARKETING CONFIGURATION
    // The admin is the only one who can write to the marketing config.
    // Any authenticated user can read it to get the link.
    match /marketing_config/{docId} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
    }
  }
}
