rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Allow public read access ONLY to the lead magnet configuration
    match /marketing_config/lead_magnet {
      allow get: if true; // Allow single document reads by anyone
      allow list: if request.auth != null && request.auth.uid == 'sRiwSuQlxgbGRUcO7CevaJxQBEq2'; // Only admin can list
      allow write: if request.auth != null && request.auth.uid == 'sRiwSuQlxgbGRUcO7CevaJxQBEq2';
    }
    
    // Allow anyone to subscribe to the newsletter
    match /newsletter_subscriptions/{subId} {
        allow create: if true;
        allow read, delete: if request.auth != null && request.auth.uid == 'sRiwSuQlxgbGRUcO7CevaJxQBEq2';
    }

    // Allow users to read notes, but only admin can write them.
    match /notes/{noteId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == 'sRiwSuQlxgbGRUcO7CevaJxQBEq2';
    }

    // Users can create their own document, and can only read/update their own.
    // Admin can read/write/delete any user document.
    match /users/{userId} {
      allow create: if true;
      allow read, update, delete: if request.auth != null && (request.auth.uid == userId || request.auth.uid == 'sRiwSuQlxgbGRUcO7CevaJxQBEq2');
      
      // Admin can manage user subcollections like progress and payments.
      // Users can write to their own progress subcollection.
      match /progress/{docId} {
        allow read, write: if request.auth != null && (request.auth.uid == userId || request.auth.uid == 'sRiwSuQlxgbGRUcO7CevaJxQBEq2');
      }
    }

    // Fallback: Deny any other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
