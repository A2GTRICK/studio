rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to identify the admin user by their UID.
    function isAdmin() {
      // UID for the designated admin account.
      return request.auth != null && request.auth.uid == "s5d4Z9q3N4Xb2P1hA6jK7cV8wFp2";
    }

    // Rule: Allow admin full access to everything.
    // This is the master rule for the admin user.
    match /{path=**} {
      allow read, write: if isAdmin();
    }

    // --- Public Read Rules for Non-Admins ---
    // The rules below apply to users who are NOT admins.
    // The `isAdmin()` check above already grants admins access,
    // so we only need to define rules for everyone else.

    // Notes, MCQs, Posts, and Notifications are publicly readable.
    match /notes/{noteId} {
      allow read: if true;
      allow write: if false; // Non-admins cannot write.
    }
    
    match /mcqSets/{setId} {
      allow read: if true;
      allow write: if false;
    }
    
    match /custom_notifications/{notificationId} {
      allow read: if true;
      allow write: if false;
    }
    
    match /posts/{postId} {
      allow read: if true;
      allow write: if false;
    }
    
    // Legacy blog collection, same rules.
    match /blog/{postId} {
        allow read: if true;
        allow write: if false;
    }

    // Test metadata is public, but questions/answers might be protected.
    match /tests/{testId} {
      allow read: if true;
      allow write: if false;
    }
    
    // Users can only read their own data.
    match /users/{uid} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow write: if false;
    }
    
    // Results can be read by any authenticated user (e.g. for leaderboards).
    match /results/{resultId} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    
    // --- Default Deny ---
    // If none of the rules above match, deny all other writes for non-admins.
    // This is implicitly handled by the rules, but stated here for clarity.
    // The master admin rule bypasses this.
  }
}
