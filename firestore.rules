rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check for admin role
    function isAdmin() {
      // UID for the admin user 'a2gtrickacademy@gmail.com'
      return request.auth.uid == 'sRiwSuQlxgbGRUcO7CevaJxQBEq2';
    }

    // Default Deny: Secure all collections by default
    match /{document=**} {
      allow read, write: if false;
    }

    // Allow authenticated users to read their own user document
    // Allow admin to read/write any user document
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId || isAdmin();
      allow create: if request.auth.uid != null;

      // Allow authenticated users to write to their own progress subcollection
      // Allow admin to read any user's progress
      match /progress/{progressId} {
         allow read: if request.auth.uid == userId || isAdmin();
         allow write: if request.auth.uid == userId;
      }
    }

    // Allow authenticated users to read notes
    // Allow admin to create, update, and delete notes
    match /notes/{noteId} {
        allow read: if request.auth != null;
        allow create, update, delete: if isAdmin();
    }
    
    // Allow admin to read/write marketing configuration
    // Allow any authenticated user to read the configuration
    match /marketing_config/{docId} {
        allow read: if request.auth != null;
        allow write: if isAdmin();
    }

    // Allow anyone to submit a newsletter subscription
    match /newsletter_subscriptions/{docId} {
        allow create: if true;
        // Only admin can read or delete subscribers
        allow read, delete: if isAdmin();
    }
  }
}
