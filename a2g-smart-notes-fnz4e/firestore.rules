rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is the owner of the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Helper function to check if the user is an administrator
    function isAdmin() {
      // Hardcoded UID for the admin user
      return request.auth.uid == 'sRiwSuQlxgbGRUcO7CevaJxQBEq2';
    }

    // Users Collection
    match /users/{userId} {
      // Allow users to read their own profile information.
      allow read: if isOwner(userId) || isAdmin();
      
      // Allow users to create their own user document.
      allow create: if isOwner(userId);
      
      // Allow users to update their own displayName.
      // NEW RULE: Allow users to create/update their 'paymentRequest' field.
      allow update: if isOwner(userId) && (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['displayName', 'lastLogin', 'paymentRequest']));

      // Admins can read/write any user document.
      allow write: if isAdmin();
      
      // Allow admins to read/write the progress sub-collection
      match /progress/{progressId} {
        allow read, write: if isAdmin() || isOwner(userId);
      }
    }

    // Notes Collection
    match /notes/{noteId} {
      // Any authenticated user can read notes.
      allow read: if request.auth != null;
      // Only admins can create, update, or delete notes.
      allow write: if isAdmin();
    }
    
    // Newsletter Subscriptions Collection
    match /newsletter_subscriptions/{subId} {
      // Anyone can create a subscription (e.g., from the landing page).
      allow create: if true;
      // Only admins can read or delete subscriptions.
      allow read, delete: if isAdmin();
      allow update: if false; // Nobody should update subscriptions
    }
  }
}
